'use strict';var _slicedToArray=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{!d&&h['return']&&h['return']()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}();Object.defineProperty(exports,'__esModule',{value:!0});function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}var moodleString=require('./xmlStrings'),availExercises=['category','multichoice','essay','shortanswer','truefalse','description','cloze','numerical','matching','order'],answerRegex=new RegExp(/^\s*answer:\s*/i),nameRegex=new RegExp(/^\s*name:\s*/i),tagRegex=new RegExp(/^\s*tag:\s*/i),gfeedRegex=new RegExp(/^\s*gfeed\.\s*/i),matchRegex=new RegExp(/^\s*match:?\s*/i),feedbackRegex=new RegExp(/^\s*feedback:\s*/i),letterRegex=new RegExp(/^\s*(\w)(:?\.|\))\s*/),addNSNC=function(a,b){b.nsnc&&a.answers.push('es'===b.lang?'NS/NC':'n/a'),b.penalty&&a.fractions.push(0)},escapeHtml=function(a){return a.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;')};String.prototype.escapeCode=function(){return this.replace(/<pre>(.+?)<\/pre>/gism,function(a,b){return'<pre>'+escapeHtml(b)+'</pre>'}).replace(/<code>(.+?)<\/code>/gism,function(a,b){return'<code>'+escapeHtml(b)+'</code>'})};var aikenToMoodleXML=function(a,b){var c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:{},d=a.split(/\n\s*\n/);try{b(moodleString(d.map(function(a){var b=Number.isNaN,d={type:'multichoice',question:''},e=a.split(/\n+/),f=e[0].replace(/\s/,''),g=availExercises.indexOf(f),h=1,j=_slicedToArray(e,1);if(d.question=j[0],-1!==g){d.type=availExercises[g],h=2;var k=_slicedToArray(e,2);d.question=k[1]}d.question=d.question?d.question.replace(/\r/,''):'','category'===d.type&&(d.categories=[d.question]);for(var l=h;l<e.length;l+=1)if('category'===d.type)d.categories.push(e[l]);else if(answerRegex.test(e[l]))d.correctAnswer=e[l].replace(answerRegex,'').replace('\r','').split(',').map(function(a){try{return'string'==typeof a?JSON.parse(a.toLowerCase()):JSON.parse(a)}catch(b){return a}}),'multichoice'===d.type&&(d.single=1===d.correctAnswer.length,d.correctAnswer=d.correctAnswer.map(function(a){try{return b(+a)&&!!a!==a?a.replace(/\s/g,'').toLowerCase().charCodeAt(0)-97:b(+a)?a:a-1}catch(b){return a}}));else if(letterRegex.test(e[l])){d.answers=[].concat(_toConsumableArray(d.answers||[]),[e[l].replace(letterRegex,'').replace('\r','').escapeCode()]);var i=e[l].match(letterRegex);'multichoice'===d.type&&(d.useLetters=d.useLetters||i&&i.length&&b(+i[1]))}else gfeedRegex.test(e[l])?d.feedback=e[l].replace(gfeedRegex,'').replace('\r','').escapeCode():feedbackRegex.test(e[l])?d.feedback=e[l].replace(feedbackRegex,'').replace('\r','').escapeCode():matchRegex.test(e[l])?d.correctAnswer=[].concat(_toConsumableArray(d.correctAnswer||[]),[e[l].replace(matchRegex,'').replace('\r','').escapeCode()]):tagRegex.test(e[l])?d.tags=e[l].replace(tagRegex,'').replace('\r','').split(',').map(function(a){try{return'string'==typeof a?JSON.parse(a.toLowerCase()):JSON.parse(a)}catch(b){return a}}):nameRegex.test(e[l])?d.name=e[l].replace(nameRegex,'').replace('\r','').escapeCode():d.question+='\n'+e[l];if(d.question=d.question&&'string'==typeof d.question?d.question.escapeCode():d.question,'shortanswer'===d.type||'numerical'===d.type)d.answers=(d.correctAnswer||[]).map(function(a){return a&&'string'==typeof a?a.replace(/^(\s)*/,''):a}),d.correctAnswer=(d.correctAnswer||[]).map(function(b,a){return a});else if('multichoice'===d.type)c.penalty&&(d.fractions=d.answers.map(function(a,b){return-1===d.correctAnswer.indexOf(b)?-(100/d.correctAnswer.length).toFixed(4):(100/d.correctAnswer.length).toFixed(4)})),!c.penalty&&1<d.answers.length&&(d.fractions=d.answers.map(function(a,b){return-1===d.correctAnswer.indexOf(b)?0:(100/d.correctAnswer.length).toFixed(4)})),d.single&&addNSNC(d,c);else if('truefalse'===d.type){c.nsnc&&(d.type='truefalse'),d.answers=['es'===c.lang?'Verdadero':'true','es'===c.lang?'Falso':'false'];var m=d.correctAnswer&&d.correctAnswer.length;d.correctAnswer=m&&d.correctAnswer[0]?[0]:[1],c.penalty&&(d.fractions=m&&0===d.correctAnswer[0]?[100,-100]:[-100,100]),addNSNC(d,c)}return d}),c))}catch(a){b(void 0,a)}};exports.default=aikenToMoodleXML,module.exports=exports['default'];